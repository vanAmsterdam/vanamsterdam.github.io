{
  "hash": "19a122c05304bb5ad1b1dde8c6801d50",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Partial residual plots with multiply imputed data\neval: true\ncategories:\n- r\n- linear regression\n- data visualization\n---\n\n\nIn an [earlier blog post](./190816-lm-functional-form.qmd) I show how to plot the dependence of a response variable on covariate, both conditional on other covariates with a [partial residual plot](https://en.wikipedia.org/wiki/Partial_residual_plot)\nIn this post I investigate how to do this when there are missing values using package `mice`.\n\nThis post will rely in Hanne Oberman's [vignette](https://cran.r-project.org/web/packages/ggmice/vignettes/ggmice.html) on `ggmice`, a plotting package for `mice::mids` objects.\n\n## Data and imputation\n\nIn this post we'll use the `boys` dataset which is provided in the `mice` package.\nThe `mice` package implements multiple imputation through chained equations[^1].\n\n[^1]: multiple imputation with chained equations sequentially imputes values for all variables with missing values by building prediction models for each variable based on other variables. This imputation is done multiple times with multiple random seeds and thus results in a number of different imputed datasets. A typical analysis workflow is to do these imputations and on each imputed dataset fit a model of interest. The coefficients of these models can then be pooled using Rubin's rules.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(mice)\nlibrary(ggplot2); theme_set(theme_bw())\n\ndf <- boys\n\nnimps <- 5\nimp <- mice(df, m = nimps, method = \"pmm\")\n```\n:::\n\n\n## Partial residual plot with complete data\n\nWe'll assume we're interested in how weight (`wgt`) depends on height (`hgt`),\ncorrected for all other variables.\nBoth have missing values in the dataset.\n\nWe can use one of the imputed datasets to show how partial residual plots are made with complete data.\nWith complete data, partial residual plots can be created like so:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf1 <- complete(imp, 1)\n\nget_partial_resid <- function(data) {\n  fit <- lm(wgt~., data=data)\n  yresid <- resid(fit)\n  return(yresid + coef(fit)['hgt'] * data$hgt)\n}\n\nplotdata1 <- data.frame(hgt=df1$hgt, y=get_partial_resid(df1))\n\nggplot(plotdata1, aes(x=hgt, y=y)) + geom_point()\n```\n\n::: {.cell-output-display}\n![Partial residual plot on complete data](240322-mice-partial-residual-plot_files/figure-html/fig-partialresidualplot-1.png){#fig-partialresidualplot width=672}\n:::\n:::\n\n\nNote how this differs from the marginal association between `hgt` and `wgt`.\nThe difference between the plots is explained by other covariates that are correlated both with `hgt` and `wgt`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(df1, aes(x=hgt, y=wgt)) + geom_point()\n```\n\n::: {.cell-output-display}\n![marginal association between age and height](240322-mice-partial-residual-plot_files/figure-html/fig-marginalplot-1.png){#fig-marginalplot width=672}\n:::\n:::\n\n\n<!--## Plots with missing data-->\n\n<!--However, not all points in plots @fig-marginalplot and @fig-partialresidualplot are actually observed.-->\n<!--The package `ggmice` provides a `ggplot2` way of plotting `mice::mids` objects.-->\n\n<!--The marginal plot can be made while showing missing data:-->\n\n<!--```{r}-->\n<!--#| label: fig-marginalggmice-->\n<!--#| fig-cap: \"marginal association with ggmice\"-->\n<!--ggmice(df, aes(x=hgt, y=wgt)) + geom_point()-->\n<!--```-->\n\n<!--In this plot you can see that some values are not observed.-->\n\n## Putting them together\n\nThe issue with the partial residual plot @fig-partialresidualplot is that the residuals depend on the imputed values for all variables.\nHow to go about this? We can treat the residuals as we would 'coefficients' in imputation and use Rubin's rules on them.\nLet's see how to do this with `mice`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nimpdfs <- complete(imp, \"all\")\nimpdfs <- lapply(impdfs, function(data) data.frame(data, partial_resid=get_partial_resid(data)))\nimpdfs <- lapply(1:nimps, function(i) data.frame(impdfs[[i]], impidx=i))\nimpdf_long <- do.call(rbind, impdfs)\n```\n:::\n\n\nNote that we cannot directly pool the residuals because they may be correlated with the imputed values for `hgt`.\nPooling imputed values for `hgt` and the partial residual removes this correlation.\nInstead we could just plot all the values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(impdf_long, aes(x=hgt, y=partial_resid)) + geom_point(aes(shape=factor(impidx)), alpha=0.5)\n```\n\n::: {.cell-output-display}\n![partial residual plot with imputed datasets](240322-mice-partial-residual-plot_files/figure-html/fig-partialresidualimp-1.png){#fig-partialresidualimp width=672}\n:::\n:::\n\n\nIn the future I'd like to learn how to make good bivariate estimates of these points (e.g. fitting a bivariate normal distribution).\nThis should for example also come up in calculating sensitivity and specificity on multiply imputed datasets, as these are clearly correlated.\nFully bayesian imputation is another possibility obviously.\n\n\n\n\n",
    "supporting": [
      "240322-mice-partial-residual-plot_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}