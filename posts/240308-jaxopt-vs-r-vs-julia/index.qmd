---
title: "Speed comparison of JaxOpt, R and Julia"
draft: true
#jupyter: julia-1.10
execute:
  eval: false
---

## Let's put them to the test

## generating data

:::: {.columns}

::: {.column width="30%"}
r
```{julia}
#| label: r-data
#| echo: true
#| eval: false
make_data <- function(n=1e3L) {
    x = rnorm(n*10)
    X = matrix(x, ncol=10)
    eta = rowSums(X)
    y = eta > 0
    # return only first 9 column to have some noise
    X2 = X2[,1:9]
    return(list(X=X,y=y))
}
```
:::

::: {.column width="5%"}
:::

::: {.column width="30%"}
```{julia}
#| label: julia-data
#| echo: true
#| eval: false
function make_data(n::Integer=1000)
    X = randn(n,10)
    eta = vec(sum(X, dims=2))
    y = eta .> 0
    X2 = X[:,1:9]
    return X2, y
end
```
:::

::: {.column width="5%"}
:::

::: {.column width="30%"}
```{julia}
#| label: julia-data2
#| echo: true
#| eval: false
function make_data(n::Integer=1000)
    X = randn(n,10)
    eta = vec(sum(X, dims=2))
    y = eta .> 0
    X2 = X[:,1:9]
    return X2, y
end
```
:::

::::

### Julia

```{julia}
#| eval: false

using CategoricalArrays, DataFrames, GLM, Random, StatsBase
using Base.Threads
import Base.Threads.@threads

# rng = StableRNG(123)
nreps = 2

Random.seed!(123)

function make_data(n::Integer=1000)
    X = randn(n,10)
    eta = vec(sum(X, dims=2))
    y = eta .> 0
    X2 = X[:,1:9]
    return X2, y
end

function solve(i::Int64=1)
    X, y = make_data()
    fit = glm(X, y, Bernoulli())
    coefs = coef(fit)
    return coefs
end

iis = 1:nreps

# outvec = Threads.Atomic{Float64}(nreps*9)
coefs = [Threads.Atomic{Float64}(0.0) for i in 1:9]
# outmat = Array{Float64,2}(undef, nreps, 9)
# outmat = zeros(nreps, 9)
@threads for i in iis
    solution = solve()
    for j in 1:9
        Threads.atomic_add!(coefs[j], solution[j])
    end

    # outmat[i,:] = solve()
end

# out = solve.(iis)
# matout = reduct(hcat, out)'

coef_vec = vec([coefi[] for coefi in coefs])
means = coef_vec ./ nreps
# means = mean(outmat, dims=1)
# sums = ThreadsX.sum(solve(i) for i in iis, dims=1)
# means = sums / nreps
print(means)
```
